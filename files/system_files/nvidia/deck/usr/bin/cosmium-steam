#!/usr/bin/bash
# based on https://github.com/ublue-os/bazzite/blob/main/system_files/desktop/shared/usr/bin/bazzite-steam

DECK_OPTION=""

# Nvidia crash fix
export __GL_CONSTANT_FRAME_RATE_HINT=3

export COSMIC_DISABLE_DIRECT_SCANOUT=1

if [ ! -d $HOME/.local/share/Steam ]; then
# Set up steam with the bootstrap before starting it, this allows steam to run for the first time even with no network access
    if [[ -f "/usr/share/gamescope-session-plus/bootstrap_steam.tar.gz" ]]; then
        mkdir -p ~/.local/share/Steam
        tar xf /usr/share/gamescope-session-plus/bootstrap_steam.tar.gz -C ~/.local/share/Steam
    fi
fi

# File toggle to override default Steam Deck flag behavior
DECK_OVERRIDE_FLAG="$HOME/.config/cosmium/disable_steamdeck_flag"

# Required to maintain the Steam update branch between desktop & Steam Game Mode
if [[ ! -f "$DECK_OVERRIDE_FLAG" ]]; then
    DECK_OPTION="-steamdeck"
else
    DECK_OPTION=""
fi

switcheroo_state="$(switcherooctl list)"

# If we're running this on a dGPU in a multi-gpu AMD/Intel system, apply a workaround for the blank Steam window bug
if [[ $(echo "${switcheroo_state}" | grep -o 'Device:' | wc -l) -gt 1 ]]; then
  # TODO: Check if -system-composer is needed with nvidia >=555 driver
  if ! grep -Pq 'Name:\s+NVIDIA' <<< "$switcheroo_state"; then
    DGPU_OPTION="-system-composer"
  fi
fi
unset -v switcheroo_state

if [[ "$XDG_SESSION_TYPE" == "wayland" ]]; then
  # https://github.com/Supreeeme/extest
  # Extest is a drop in replacement for the X11 XTEST extension.
  # It creates a virtual device with the uinput kernel module.
  # It's been primarily developed for allowing the desktop functionality
  # on the Steam Controller to work while Steam is open on Wayland.
  # Also supports Steam Input as a whole.
  env LD_PRELOAD=/usr/lib/extest/libextest.so /usr/bin/steam "$DECK_OPTION" "$@"
else
  /usr/bin/steam "$DECK_OPTION" "$@"
fi
