modules:
  - type: script
    scripts:
      - bazzite-kernel.sh
    snippets:
      - "dnf5 -y install --nogpgcheck --repofrompath 'terra,https://repos.fyralabs.com/terra$releasever' terra-release{,-extras}"
      - "dnf5 -y install https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm"
      - "dnf5 -y config-manager setopt '*fedora*'.exclude='mesa-* steam'"
      - "dnf5 -y config-manager setopt '*staging*'.exclude='mesa*'"
      - "dnf5 -y config-manager setopt '*terra*'.priority=3 '*terra*'.exclude='nerd-fonts topgrade steam'"
      - "dnf5 -y config-manager setopt 'terra-mesa'.enabled=true"
      - "dnf5 -y config-manager setopt 'terra-nvidia'.enabled=false"
      - "dnf5 -y config-manager setopt '*rpmfusion*'.priority=5 '*rpmfusion*'.exclude='mesa-*'"
      - "dnf5 -y install libaacs libbdplus"

  - type: dnf
    repos:
      cleanup: true
      copr:
        - bazzite-org/bazzite
        - bazzite-org/bazzite-multilib
        - ublue-os/staging
      files:
        - https://negativo17.org/repos/fedora-steam.repo
        - https://pkgs.tailscale.com/stable/fedora/tailscale.repo
    install:
      install-weak-deps: false
      packages:
        - steam
        - extest.i686
        - tailscale
        - steamdeck-backgrounds
        - gamescope.x86_64
        - gamescope-libs.x86_64
        - gamescope-libs.i686
        - gamescope-shaders
        - jupiter-sd-mounting-btrfs
        - umu-launcher
        - dbus-x11
        - xdg-user-dirs
        - gobject-introspection
        - libFAudio.x86_64
        - libFAudio.i686
        - vkBasalt.x86_64
        - vkBasalt.i686
        - mangohud.x86_64
        - mangohud.i686
        - libbluray-utils
        - mesa-va-drivers.i686
    replace:
      - from-repo: copr:copr.fedorainfracloud.org:bazzite-org:bazzite
        packages:
          - wireplumber
      - from-repo: copr:copr.fedorainfracloud.org:bazzite-org:bazzite-multilib
        packages:
          - pipewire
          - bluez
          - xorg-x11-server-Xwayland
      - from-repo: terra-extras
        packages:
          - switcheroo-control
      - from-repo: copr:copr.fedorainfracloud.org:ublue-os:staging
        packages:
          - fwupd
      - from-repo: copr:copr.fedorainfracloud.org:bazzite-org:bazzite
        packages:
          - ibus
    remove:
      packages:
        - firefox
        - firefox-langpacks
        - cosmic-store
        - ublue-os-update-services
        - rpmfusion-free-release
  
  - type: script
    snippets:
      - "dnf5 versionlock add pipewire pipewire-alsa pipewire-gstreamer pipewire-jack-audio-connection-kit pipewire-jack-audio-connection-kit-libs pipewire-libs pipewire-plugin-libcamera pipewire-pulseaudio pipewire-utils wireplumber wireplumber-libs bluez bluez-cups bluez-libs bluez-obexd xorg-x11-server-Xwayland switcheroo-control mesa-dri-drivers mesa-filesystem mesa-libEGL mesa-libGL mesa-libgbm mesa-va-drivers mesa-vulkan-drivers fwupd fwupd-plugin-flashrom fwupd-plugin-modem-manager fwupd-plugin-uefi-capsule-data ibus"
      - "sed -i 's@/usr/bin/steam@/usr/bin/cosmium-steam@g' /usr/share/applications/steam.desktop"
      - "mkdir -p /etc/skel/.config/autostart"
      - "cp /usr/share/applications/steam.desktop /etc/skel/.config/autostart/steam.desktop"
      - "sed -i 's@cosmium-steam@cosmium-steam -silent@g' /etc/skel/.config/autostart/steam.desktop"

  - type: brew
    auto-update: false # we'll use uupd for this
    auto-upgrade: false

  - type: files
    files:
      - source: system_files/shared
        destination: /
