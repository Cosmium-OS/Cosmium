modules:
  - type: copy
    from: ghcr.io/ublue-os/akmods-nvidia-open:bazzite-42-x86_64
    src: /rpms
    dest: /tmp/akmods-nv-rpms

  - type: script
    snippets:
      - "dnf5 config-manager setopt 'terra-mesa'.enabled=1"

  - type: dnf
    install:
      packages:
        - egl-wayland.x86_64
        - egl-wayland.i686
        - egl-wayland2.x86_64
        - egl-wayland2.i686
    remove:
      packages:
        - nvidia-gpu-firmware
        - rocm-hip
        - rocm-opencl
        - rocm-clinfo
        - rocm-smi

  - type: script
    snippets:
      - "find /tmp/akmods-nv-rpms/"
      - "dnf5 config-manager setopt fedora-cisco-openh264.enabled=0"
      - "dnf5 -y install /tmp/akmods-nv-rpms/ublue-os/ublue-os-nvidia-addons-*.rpm"
  
  - type: dnf
    install:
      packages:
        - mesa-dri-drivers.i686
        - mesa-filesystem.i686
        - mesa-libEGL.i686
        - mesa-libGL.i686
        - mesa-libgbm.i686
        - mesa-va-drivers.i686
        - mesa-vulkan-drivers.i686

  - type: script
    snippets:
      - "dnf5 config-manager setopt fedora-nvidia.enabled=1 nvidia-container-toolkit.enabled=1"
      - "dnf5 config-manager setopt fedora-multimedia.enabled=0"
      - "source /tmp/akmods-nv-rpms/kmods/nvidia-vars"

  - type: dnf
    repos:
      cleanup: true
      copr:
        - ublue-os/staging
    install:
      packages:
        - libnvidia-fbc
        - libnvidia-ml.i686
        - libva-nvidia-driver
        - nvidia-driver
        - nvidia-driver-cuda
        - nvidia-driver-cuda-libs.i686
        - nvidia-driver-libs.i686
        - nvidia-settings
        - nvidia-container-toolkit

  - type: script
    snippets:
      - "dnf5 -y install /tmp/akmods-nv-rpms/kmods/kmod-nvidia-*.rpm"

  - type: script
    scripts:
      - finalize-nvidia.sh

  - type: files
    files:
      - source: system_files/nvidia/shared
        destination: /
